# ğŸ—ï¸ **AllApp Python Backend Architecture**

---

## ğŸ§© **Tech Stack Overview**

- **Web Framework**: `FastAPI` (async, scalable API service)
- **Database**: `PostgreSQL` (with SQLAlchemy)
- **ORM**: `SQLAlchemy + Alembic`
- **Task Queue**: `Celery` with `Redis`
- **Storage**: S3-compatible (AWS S3 or MinIO)
- **Authentication**: OAuth2/JWT
- **WebSockets**: Native FastAPI + Redis PubSub
- **File Structure**: Modular Monorepo (feature-based)

---

## ğŸ—‚ï¸ **Project Structure**

```
allapp/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                     # FastAPI instance and routers inclusion
â”‚   â”œâ”€â”€ config.py                   # Settings, env variables, keys
â”‚   â”œâ”€â”€ core/                       # Core utilities
â”‚   â”‚   â”œâ”€â”€ security.py             # JWT tokens, hashing, auth guards
â”‚   â”‚   â”œâ”€â”€ permissions.py          # Role-based access controls
â”‚   â”‚   â””â”€â”€ verification.py         # Civic test logic, ID checks
â”‚   â”œâ”€â”€ models/                     # SQLAlchemy models (modular)
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ job.py
â”‚   â”‚   â”œâ”€â”€ project.py
â”‚   â”‚   â”œâ”€â”€ wallet.py
â”‚   â”‚   â”œâ”€â”€ transaction.py
â”‚   â”‚   â””â”€â”€ sector.py
â”‚   â”œâ”€â”€ schemas/                    # Pydantic request/response models
â”‚   â”‚   â””â”€â”€ job.py, user.py, ...
â”‚   â”œâ”€â”€ crud/                       # Database interactions
â”‚   â”‚   â””â”€â”€ job.py, user.py, ...
â”‚   â”œâ”€â”€ services/                   # Business logic
â”‚   â”‚   â”œâ”€â”€ copin.py                # Wallet/transaction logic
â”‚   â”‚   â”œâ”€â”€ civic_test.py
â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â””â”€â”€ map.py
â”‚   â”œâ”€â”€ api/                        # API routes
â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”‚   â”œâ”€â”€ job.py
â”‚   â”‚   â”‚   â”œâ”€â”€ project.py
â”‚   â”‚   â”‚   â””â”€â”€ wallet.py
â”‚   â”‚   â””â”€â”€ api_router.py          # Combine all routers
â”‚   â”œâ”€â”€ workers/                    # Celery background jobs
â”‚   â”‚   â”œâ”€â”€ tasks.py                # Notifications, reminders
â”‚   â”‚   â””â”€â”€ periodic.py            # Monthly checks (data cleanup)
â”‚   â””â”€â”€ websocket/                 # Real-time features
â”‚       â””â”€â”€ chat.py                # Chat, presence
â”‚
â”œâ”€â”€ tests/                         # Pytest suite
â”‚   â””â”€â”€ test_jobs.py, test_user.py ...
â”œâ”€â”€ alembic/                       # Migrations
â”œâ”€â”€ requirements.txt / pyproject.toml
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

---

## ğŸ” **Modular Domains (by Feature)**

Each **feature = its own model + schema + routes + services + CRUD logic**:

| Feature       | Responsibility |
|---------------|----------------|
| **Users**      | Auth, profile, role access, verification, privacy settings |
| **Jobs**       | Post/apply/track jobs, rating logic |
| **Projects**   | Milestones, contributions, chat, comment system |
| **Wallet**     | Copin balance, transfers, transactions |
| **Education**  | Courses, civic test, badges, certificates |
| **Groups**     | Teams, forums, discussions |
| **Chat**       | WebSockets, message threads |
| **Calendar**   | Event syncing, reminders |
| **Map**        | Sector-tagged locations, services, POIs |
| **Sector Tags**| All content tagged for categorization and filtering |
| **Public Services** | Directory with data validation tools |

---

## ğŸ› ï¸ **Core Concepts**

### 1. **Dependency Injection (FastAPI)**
- Inject current user, access level, sector context into every route
- Example: `Depends(get_current_user)` or `Depends(require_verified_user)`

---

### 2. **Role-Based Access**
```python
def require_full_user(user: User = Depends(get_current_user)):
    if not user.is_verified or not user.civic_passed:
        raise HTTPException(403, "Full access not granted")
    return user
```

---

### 3. **Permissions Middleware**
- Before any CRUD action (like posting, reviewing), check:
  - Civic test
  - Participation history (e.g., visited location)
  - Ownership/admin status

---

### 4. **Event & Message Bus**
- Use **Redis PubSub** to trigger:
  - Notification events (new job posted, payout received)
  - Status updates (project declared finished)
  - Chat messages

---

### 5. **Task Queue (Celery)**
- Use for:
  - Monthly data confirmation check
  - Batch transaction cleanup
  - Email or push notifications
  - Civic test scoring + user ranking updates

---

### 6. **Copin Ledger Model (Simplified)**

```python
class Transaction(Base):
    id = Column(UUID, primary_key=True, default=uuid4)
    sender_id = Column(UUID, ForeignKey('user.id'))
    receiver_id = Column(UUID, ForeignKey('user.id'))
    amount = Column(DECIMAL)
    fee = Column(DECIMAL)
    type = Column(String)  # transfer, reward, withdrawal
    timestamp = Column(DateTime, default=datetime.utcnow)
    description = Column(Text)
```

---

## ğŸ§ª Testing Strategy

- Use **Pytest** with `TestClient` for endpoint testing
- Factory Boy for test users/data
- Coverage tracking + CI hooks via **GitHub Actions**

---

## ğŸ”Œ DevOps & Deployment (Containerized)

- **Docker + Docker Compose** for dev environments
- **NGINX + Gunicorn/Uvicorn** for production FastAPI serving
- **S3 or MinIO** for media/document storage
- Use **Traefik or API Gateway** for service rate limiting and security

---

## âœ… Summary: Scalable Python Architecture for AllApp

- **Feature-based structure** keeps logic clean and maintainable  
- **FastAPI + SQLAlchemy** is lightweight, async, and modular  
- **Celery + Redis** covers async needs  
- **Copin logic** is ledger-driven with real-world transparency  
- WebSockets + Chat, Calendar, Civic System, and Wallet are **isolated modules**  
- All deeply integrated with **permissions, roles, and privacy logic**
